<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <script src="test-deps/base64-js/base64js.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="test-deps/jszip.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="test-deps/FileSaver.min.js" type="text/javascript" charset="utf-8"></script>

        <script src="citestate.js" type="text/javascript" charset="utf-8"></script>
        <script src="recorder/recorder-worker.js" type="text/javascript" charset="utf-8"></script>
        <title>Cite Game State</title>
        <script>
         function saveFiles(filemap) {
             var zip = new JSZip();
             for (var path in filemap) {
                 var outpath = path;
                 if(outpath[0] == "/") {
                     outpath = outpath.slice(1);
                 }
                 /*                  console.log(filemap[path]); */
                 zip.file(outpath, filemap[path]);
             }
             zip.generateAsync({
                 type:"blob",
                 compression:"DEFLATE",
                 compressionOptions: {level:6}
             }).then(function (blob) {
                 /*                     console.log("done"); */
                 saveAs(blob, "save.zip");
                });
         }
         function saveState() {
             emu.saveState(function(stateData) {
                 emu.saveExtraFiles(
                     emu.listExtraFiles(),
                     function(filemap) {
                         // TODO generalize to nes snes etc
                         var fs = {"/meta.json":JSON.stringify({"emulator":"dosbox"}),
                                   "/heap.heap":stateData.heap.slice(),
                                   "/data.json":JSON.stringify({
                                       "time":stateData.time,
                                       "stack":stateData.stack,
                                       "emtStack":stateData.emtStack
                                   })
                         };
                         for (var k in filemap) {
                             fs["/files"+k] = filemap[k];
                         }
                         saveFiles(fs);
                     }
                 )
             })
         }

         function manageLoadState(stateData){
             savedState = stateData;
         }

         function manageSaveExtraFiles(fileMapping){
             var fm = fileMapping;
             console.log(fm);
         }

         function listFilePaths(emu){
             var paths = [];
             for (var fileName in emu.extraFiles){
                 paths.push(fileName);
             }
             return paths;
         }
         /*
          *          function readState(data) {
          *              var num = (new Uint32Array(data,0,1))[0];
          *              if (num == 1) {
          *                  return new Uint8Array(data, 4+4);
          *              }
          *              if (num != 2) {
          *                  console.error("Invalid state");
          *                  return null;
          *              }
          *              var lens = new Uint32Array(data, 4, num);
          *              if (lens[1] != 4*3) {
          *                  console.error("Invalid state");
          *                  return null;
          *              }
          *              var start = 4 + 4 * num;
          *              var heap = new Uint8Array(data, start, lens[0]);
          *              start += lens[0];
          *              var ptrs = new Uint32Array(data, start, lens[1]/4);
          *              if (ptrs.length != 3) {
          *                  console.error("Invalid state");
          *                  return null;
          *              }
          *              return {heap:heap,
          *                      emtStack:ptrs[0],
          *                      stack:ptrs[1],
          *                      time:ptrs[2]}
          *          } */

         function reload() {
             var req = new XMLHttpRequest();
             req.responseType = 'arraybuffer';
             req.addEventListener("load", function () {
                 window.emu.loadState(readState(this.response), function(s) {
                     console.log("DOSbox loaded state from freeze data");
                 }, function(s) {
                     console.error("DOSbox error loading state");
                 });
             });
             req.open("GET", "doom-save");
             req.send();
         }
        </script>
    </head>
    <body>
        <div id="target" style="width:320px; height:240px"></div>
        <a style="color:blue" onclick="emu.setMuted(!emu.isMuted())">Toggle audio</a>
        <a style="color:red" onclick="saveState()">Save State</a>

        <a style="color:green" onclick="startup()">Start Fresh</a>
        <a style="color:green" onclick="reload(\"doom-save-1\")">Reload State 1</a>
        <a style="color:green" onclick="reload(\"doom-save-2\")">Reload State 2</a>

    </body>
    <script>
     function startup() {
         CiteState.cite("target", function (emu) {
             window.emu = emu;
         }, "INSTALL.BAT", null, null, {
             "DEICE.EXE": "doom/DEICE.EXE",
             "DOOMS_19.1": "doom/DOOMS_19.1",
             "DOOMS_19.2": "doom/DOOMS_19.2",
             "DOOMS_19.DAT": "doom/DOOMS_19.DAT",
             "INSTALL.BAT": "doom/INSTALL.BAT"
         }, {mute:true, recorder:{}});
     }
    </script>
</html>
